================================================================================
AULA 2.2 - PARTE 3: CONFIGURAÃ‡ÃƒO E SETUP INICIAL
CÃ“DIGO COMPLETO DE TODOS OS ARQUIVOS
================================================================================

Este arquivo contÃ©m o cÃ³digo completo de todos os arquivos modificados ou
criados nesta aula. Use como referÃªncia durante a implementaÃ§Ã£o.

================================================================================


================================================================================
1. EnvironmentConfig.swift - EXPANDIDO
================================================================================
Status: ARQUIVO EXISTENTE DA AULA 2.1 - ADICIONAR CÃ“DIGO NO FINAL
Linhas adicionadas: ~70 linhas
================================================================================

//
//  EnvironmentConfig.swift
//  FinancasApp
//
//  Created by DiÃ³genes Reis on 29/09/25.
//

import Foundation
import FirebaseFirestore  // âœ… ADICIONAR ESTE IMPORT

// ğŸ—ï¸ CONFIGURAÃ‡ÃƒO PROFISSIONAL DE AMBIENTES
enum Environment {
    case development, staging, production

    static var current: Environment {
        #if DEBUG
        return .development
        #elseif STAGING
        return .staging
        #else
        return .production
        #endif
    }
}


struct EnvironmentConfig {
    static var projectId: String {
        switch Environment.current {
        case .development: return "financas-app-dev"
        case .staging: return "financas-app-staging"
        case .production: return "financas-app-prod"
        }
    }
    
    // ========================================================================
    // âœ… ADICIONAR TODO O CÃ“DIGO ABAIXO (NOVO NA AULA 2.2 PARTE 3)
    // ========================================================================
    
    // âš™ï¸ CONFIGURAÃ‡Ã•ES ESPECÃFICAS DO FIRESTORE
    static var firestoreSettings: FirestoreSettings {
        let settings = FirestoreSettings()
        
        switch Environment.current {
        case .development:
            // ğŸ’¾ DESENVOLVIMENTO: Cache agressivo para velocidade
            settings.cacheSizeBytes = 100_000_000 // 100MB
            settings.isPersistenceEnabled = true
            print("   ğŸ“ Cache: 100MB (Development)")
            
        case .staging:
            // ğŸ§ª STAGING: ConfiguraÃ§Ã£o hÃ­brida
            settings.cacheSizeBytes = 75_000_000 // 75MB
            settings.isPersistenceEnabled = true
            print("   ğŸ“ Cache: 75MB (Staging)")
            
        case .production:
            // ğŸš€ PRODUÃ‡ÃƒO: Otimizado para bateria
            settings.cacheSizeBytes = 50_000_000 // 50MB
            settings.isPersistenceEnabled = true
            print("   ğŸ“ Cache: 50MB (Production)")
        }
        
        // ğŸ›¡ï¸ SEGURANÃ‡A: SSL sempre ativo
        settings.isSSLEnabled = true
        
        return settings
    }
    
    // ğŸ“Š DEBUG LOGGING POR AMBIENTE
    static var debugLogging: Bool {
        switch Environment.current {
        case .development, .staging:
            return true
        case .production:
            return false
        }
    }
    
    // ğŸ“± NOME DO AMBIENTE PARA EXIBIÃ‡ÃƒO
    static var environmentName: String {
        switch Environment.current {
        case .development:
            return "ğŸ”§ Development"
        case .staging:
            return "ğŸ§ª Staging"
        case .production:
            return "ğŸš€ Production"
        }
    }
}


================================================================================
2. FirestoreConfiguration.swift - NOVO
================================================================================
Status: CRIAR NOVO ARQUIVO
Linhas totais: ~60 linhas
================================================================================

//
//  FirestoreConfiguration.swift
//  FinancasApp
//
//  Created by [Seu Nome] on [Data]
//

import Foundation
import FirebaseCore
import FirebaseFirestore

// MARK: - âš™ï¸ ConfiguraÃ§Ã£o Centralizada do Firestore
/*
 ğŸ“ CLASSE DE CONFIGURAÃ‡ÃƒO AVANÃ‡ADA
 
 ğŸ¯ Expande a configuraÃ§Ã£o bÃ¡sica da Aula 2.1 com:
 â€¢ Cache offline otimizado por ambiente
 â€¢ Logging inteligente
 â€¢ ValidaÃ§Ã£o de settings aplicados
 */
class FirestoreConfiguration {
    
    // ğŸ¯ CONFIGURAÃ‡ÃƒO AVANÃ‡ADA (CHAMADA APÃ“S FirebaseApp.configure())
    static func configureAdvanced() {
        let db = Firestore.firestore()
        
        print("âš™ï¸ Aplicando configuraÃ§Ãµes avanÃ§adas Firestore...")
        print("ğŸ“Š Ambiente: \(EnvironmentConfig.environmentName)")
        
        // ğŸ“Š APLICAR SETTINGS DO AMBIENTE
        db.settings = EnvironmentConfig.firestoreSettings
        
        // ğŸ¯ CONFIGURAR LOGGING
        configureLogging()
        
        // âœ… CONFIRMAR CONFIGURAÃ‡ÃƒO
        logConfigurationStatus(db: db)
    }
    
    // ğŸ“ CONFIGURAÃ‡ÃƒO DE LOGGING
    private static func configureLogging() {
        if EnvironmentConfig.debugLogging {
            print("   ğŸ“ Debug logging: HABILITADO")
            
            // ğŸ” Firebase internal logging (sÃ³ desenvolvimento)
            if Environment.current == .development {
                FirebaseConfiguration.shared.setLoggerLevel(.debug)
            }
        } else {
            print("   ğŸ”‡ Debug logging: DESABILITADO (ProduÃ§Ã£o)")
            FirebaseConfiguration.shared.setLoggerLevel(.error)
        }
    }
    
    // ğŸ“Š LOG DO STATUS DA CONFIGURAÃ‡ÃƒO
    private static func logConfigurationStatus(db: Firestore) {
        let settings = db.settings
        
        print("âœ… ConfiguraÃ§Ã£o avanÃ§ada aplicada:")
        print("   â€¢ Cache offline: \(settings.isPersistenceEnabled ? "ATIVO" : "INATIVO")")
        print("   â€¢ Tamanho cache: \(settings.cacheSizeBytes / 1_000_000)MB")
        print("   â€¢ SSL: \(settings.isSSLEnabled ? "ATIVO" : "INATIVO")")
        print("   â€¢ Ambiente: \(EnvironmentConfig.environmentName)")
    }
}


================================================================================
3. ConfigurationValidator.swift - NOVO
================================================================================
Status: CRIAR NOVO ARQUIVO
Linhas totais: ~110 linhas
================================================================================

//
//  ConfigurationValidator.swift
//  FinancasApp
//
//  Created by [Seu Nome] on [Data]
//

import Foundation
import FirebaseFirestore

// MARK: - ğŸ§ª Validador AutomÃ¡tico de ConfiguraÃ§Ã£o
/*
 ğŸ“ VALIDA A CONFIGURAÃ‡ÃƒO DO FIREBASE
 
 ğŸ¯ Testa automaticamente:
 â€¢ ConexÃ£o com Firestore
 â€¢ Settings aplicados corretamente
 â€¢ OperaÃ§Ã£o bÃ¡sica funcionando
 */
class ConfigurationValidator {
    
    // ğŸ§ª RESULTADO DA VALIDAÃ‡ÃƒO
    struct ValidationResult {
        let isValid: Bool
        let message: String
    }
    
    // ğŸ” VALIDAÃ‡ÃƒO COMPLETA
    static func validateSetup() async -> ValidationResult {
        print("\nğŸ§ª Validando configuraÃ§Ã£o avanÃ§ada...")
        
        // âœ… 1. TESTAR CONEXÃƒO
        let connectionOK = await testConnection()
        if !connectionOK {
            return ValidationResult(
                isValid: false,
                message: "âŒ Falha na conexÃ£o com Firestore"
            )
        }
        
        // âœ… 2. VALIDAR SETTINGS
        let settingsOK = validateSettings()
        if !settingsOK {
            return ValidationResult(
                isValid: false,
                message: "âš ï¸ ConfiguraÃ§Ãµes nÃ£o aplicadas corretamente"
            )
        }
        
        // âœ… 3. TESTAR OPERAÃ‡ÃƒO
        let operationOK = await testOperation()
        if !operationOK {
            return ValidationResult(
                isValid: false,
                message: "âŒ Falha no teste de operaÃ§Ã£o"
            )
        }
        
        print("âœ… ValidaÃ§Ã£o completa: SUCESSO!\n")
        return ValidationResult(
            isValid: true,
            message: "ğŸ‰ ConfiguraÃ§Ã£o avanÃ§ada validada!"
        )
    }
    
    // ğŸ”— TESTE DE CONEXÃƒO
    private static func testConnection() async -> Bool {
        do {
            let db = Firestore.firestore()
            print("   ğŸ”— Testando conexÃ£o...")
            
            // OperaÃ§Ã£o mÃ­nima para validar conectividade
            _ = try await db.collection("config_validation")
                .document("test")
                .getDocument()
            
            print("   âœ… ConexÃ£o OK")
            return true
        } catch {
            print("   âŒ Erro de conexÃ£o: \(error.localizedDescription)")
            return false
        }
    }
    
    // âš™ï¸ VALIDAÃ‡ÃƒO DE SETTINGS
    private static func validateSettings() -> Bool {
        let db = Firestore.firestore()
        let settings = db.settings
        
        print("   âš™ï¸ Validando settings aplicados...")
        
        // Verificar configuraÃ§Ãµes crÃ­ticas
        guard settings.isSSLEnabled else {
            print("   âŒ SSL nÃ£o estÃ¡ habilitado")
            return false
        }
        
        guard settings.isPersistenceEnabled else {
            print("   âš ï¸ Cache offline nÃ£o estÃ¡ habilitado")
            return false
        }
        
        print("   âœ… Settings validados")
        return true
    }
    
    // ğŸ’¾ TESTE DE OPERAÃ‡ÃƒO
    private static func testOperation() async -> Bool {
        do {
            let db = Firestore.firestore()
            print("   ğŸ’¾ Testando operaÃ§Ã£o de escrita...")
            
            let testData: [String: Any] = [
                "validated": true,
                "timestamp": Timestamp(),
                "environment": EnvironmentConfig.environmentName
            ]
            
            try await db.collection("config_validation")
                .document("test")
                .setData(testData)
            
            print("   âœ… OperaÃ§Ã£o OK")
            return true
        } catch {
            print("   âŒ Erro na operaÃ§Ã£o: \(error.localizedDescription)")
            return false
        }
    }
}


================================================================================
4. FinancasAppApp.swift - MODIFICADO
================================================================================
Status: ARQUIVO EXISTENTE - MODIFICAR MÃ‰TODO configureFirebase() E BODY
ModificaÃ§Ãµes: ~15 linhas modificadas/adicionadas
================================================================================

//
//  FinancasAppApp.swift
//  FinancasApp
//
//  Created by DiÃ³genes Reis on 24/09/25.
//

import SwiftUI
import Firebase

@main
struct FinancasAppApp: App {
    
    init() {
        // ğŸ”¥ CONFIGURAÃ‡ÃƒO DO FIREBASE
        configureFirebase()
    }
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .task {
                    // ========================================
                    // âœ… ADICIONAR ESTE BLOCO .task (NOVO)
                    // ========================================
                    // ğŸ§ª VALIDAÃ‡ÃƒO AUTOMÃTICA
                    print("ğŸ§ª Executando validaÃ§Ã£o automÃ¡tica...")
                    let result = await ConfigurationValidator.validateSetup()
                    
                    if result.isValid {
                        print("ğŸ‰ App pronto para uso!")
                    } else {
                        print("âš ï¸ \(result.message)")
                    }
                }
        }
    }
    
    // ========================================================================
    // âœ… SUBSTITUIR TODO O MÃ‰TODO configureFirebase() PELO CÃ“DIGO ABAIXO
    // ========================================================================
    private func configureFirebase() {
        print("ğŸ”¥ Iniciando configuraÃ§Ã£o do Firebase...")
        print("ğŸ“Š Ambiente detectado: \(EnvironmentConfig.environmentName)")
        
        // ğŸ“‹ Verificar arquivo de configuraÃ§Ã£o
        guard let path = Bundle.main.path(
            forResource: "GoogleService-Info",
            ofType: "plist"
        ) else {
            print("âŒ GoogleService-Info.plist nÃ£o encontrado!")
            fatalError("Firebase config missing")
        }
        
        print("âœ… Arquivo encontrado")
        
        // ğŸš€ 1. CONFIGURAÃ‡ÃƒO BASE (Aula 2.1)
        FirebaseApp.configure()
        print("âœ… Firebase App inicializado")
        
        // âš™ï¸ 2. CONFIGURAÃ‡ÃƒO AVANÃ‡ADA (Aula 2.2 - NOVO!)
        FirestoreConfiguration.configureAdvanced()
        print("âœ… Firestore otimizado para \(EnvironmentConfig.environmentName)")
        
        print("ğŸ‰ ConfiguraÃ§Ã£o completa finalizada!\n")
    }
}


================================================================================
RESUMO DAS MODIFICAÃ‡Ã•ES
================================================================================

âœï¸ ARQUIVOS EXPANDIDOS (Aula 2.1 â†’ Aula 2.2):
   â€¢ EnvironmentConfig.swift
     - Adicionar import FirebaseFirestore
     - Adicionar ~70 linhas de configuraÃ§Ãµes Firestore
   
   â€¢ FinancasAppApp.swift
     - Modificar mÃ©todo configureFirebase() (adicionar configuraÃ§Ã£o avanÃ§ada)
     - Adicionar bloco .task no body (validaÃ§Ã£o automÃ¡tica)

âœ¨ ARQUIVOS NOVOS (Aula 2.2 Parte 3):
   â€¢ FirestoreConfiguration.swift (~60 linhas)
   â€¢ ConfigurationValidator.swift (~110 linhas)

âœ… ARQUIVOS MANTIDOS SEM ALTERAÃ‡ÃƒO:
   â€¢ ContentView.swift
   â€¢ FirebaseTestManager.swift
   â€¢ GoogleService-Info.plist

================================================================================
LOGS ESPERADOS NO CONSOLE APÃ“S IMPLEMENTAÃ‡ÃƒO
================================================================================

ğŸ”¥ Iniciando configuraÃ§Ã£o do Firebase...
ğŸ“Š Ambiente detectado: ğŸ”§ Development
âœ… Arquivo encontrado
âœ… Firebase App inicializado
âš™ï¸ Aplicando configuraÃ§Ãµes avanÃ§adas Firestore...
ğŸ“Š Ambiente: ğŸ”§ Development
   ğŸ“ Cache: 100MB (Development)
   ğŸ“ Debug logging: HABILITADO
âœ… ConfiguraÃ§Ã£o avanÃ§ada aplicada:
   â€¢ Cache offline: ATIVO
   â€¢ Tamanho cache: 100MB
   â€¢ SSL: ATIVO
   â€¢ Ambiente: ğŸ”§ Development
âœ… Firestore otimizado para ğŸ”§ Development
ğŸ‰ ConfiguraÃ§Ã£o completa finalizada!

ğŸ§ª Executando validaÃ§Ã£o automÃ¡tica...
ğŸ§ª Validando configuraÃ§Ã£o avanÃ§ada...
   ğŸ”— Testando conexÃ£o...
   âœ… ConexÃ£o OK
   âš™ï¸ Validando settings aplicados...
   âœ… Settings validados
   ğŸ’¾ Testando operaÃ§Ã£o de escrita...
   âœ… OperaÃ§Ã£o OK
âœ… ValidaÃ§Ã£o completa: SUCESSO!

ğŸ‰ App pronto para uso!

================================================================================
FIM DO CÃ“DIGO COMPLETO
================================================================================